{% extends "admin/base_site.html" %}
{% load static %}

{% block nav-global %}
    {{ block.super }}
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        /* Ø¢ÛŒÚ©ÙˆÙ† Ù†ÙˆØªÛŒÙ */
        #notif-icon {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
            font-size: 24px;
            color: #ffffff;
            /* Ù…Ù‡Ù…: Ù‡ÛŒÚ† transform Ø±ÙˆÛŒ ÙˆØ§Ù„Ø¯ Ù†Ø°Ø§Ø± ØªØ§ dropdown Ø«Ø§Ø¨Øª Ù†Ø¬Ù‡ */
            transition: color 0.2s ease;
        }
        #notif-icon:hover { color: #ffd700; }

        /* Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ */
        #notif-count {
            background: linear-gradient(45deg, #ff3b30, #ff6b6b);
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
            display: none;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        /* Dropdown: Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ø§Ø®Ù„ ØµÙØ­Ù‡ Ø¨Ù…ÙˆÙ†Ù‡ */
        #notif-dropdown {
            display: none;
            position: fixed;             /* Ù†Ø³Ø¨Øª Ø¨Ù‡ ÙˆÛŒÙˆÙ¾ÙˆØ±Øª */
            top: 60px;                   /* Ú©Ù…ÛŒ Ø²ÛŒØ± Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ */
            right: 20px;                 /* ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø±Ø§Ø³Øª */
            background: #1c2526;
            border-radius: 12px;
            width: min(90vw, 360px);     /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.25s ease;
            font-family: 'Poppins', sans-serif;
            color: #ffffff;
            overflow-wrap: break-word;
        }
        #notif-dropdown.open { display: block; }  /* Ú©Ù„Ø§Ø³ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ */

        #notif-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #notif-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }
        #mark-all-read {
            background: none;
            border: none;
            color: #ffd700;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        #mark-all-read:hover { color: #ffffff; }

        #notif-list {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }
        #notif-list li {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #notif-list li:hover { background: rgba(255,255,255,0.08); }
        #notif-list li.unread { background: rgba(255,215,0,0.08); font-weight: 500; }

        #notif-list li a {
            color: #ffffff;
            text-decoration: none;
            display: block;
            flex: 1;
            white-space: normal;
            word-break: break-word;
        }

        .notif-icon { font-size: 16px; color: #ffd700; }
        .notif-time { font-size: 12px; color: rgba(255,255,255,0.6); white-space: nowrap; }

        #notif-list::-webkit-scrollbar { width: 8px; }
        #notif-list::-webkit-scrollbar-thumb { background: #ffd700; border-radius: 4px; }
        #notif-list::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Ø§Ø­ØªÛŒØ§Ø·ÛŒ: Ø§Ø³Ú©Ø±ÙˆÙ„ Ø§ÙÙ‚ÛŒ Ú©Ù„ ØµÙØ­Ù‡ ØºÛŒØ±ÙØ¹Ø§Ù„ */
        html, body { overflow-x: hidden; }

        @media (max-width: 600px) {
            #notif-header h3 { font-size: 14px; }
            #notif-list li { font-size: 13px; padding: 10px; }
            .notif-time { font-size: 11px; }
        }
    </style>

    <div id="notif-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span id="notif-count"></span>
        <div id="notif-dropdown">
            <div id="notif-header">
                <h3>Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</h3>
                <button id="mark-all-read">Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡</button>
            </div>
            <ul id="notif-list">
                <li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(protocol + "://" + window.location.host + "/ws/notifications/");

        const icon = document.getElementById("notif-icon");
        const dropdown = document.getElementById("notif-dropdown");
        const notifList = document.getElementById("notif-list");
        const notifCount = document.getElementById("notif-count");
        const markAllRead = document.getElementById("mark-all-read");

        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let unreadCount = notifications.length;

        // Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ø§ Ú©Ù„Ø§Ø³ (Ø¨Ø¯ÙˆÙ† Ø¯Ø³Øªâ€ŒÚ©Ø§Ø±ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… style.display)
        icon.addEventListener("click", function (e) {
            e.stopPropagation();
            dropdown.classList.toggle("open");
            renderNotifications();
        });
        // Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
        document.addEventListener("click", function (e) {
            if (!icon.contains(e.target)) dropdown.classList.remove("open");
        });
        // Ø¨Ø³ØªÙ† Ø¨Ø§ ESC
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") dropdown.classList.remove("open");
        });

        // Ø¯Ø±ÛŒØ§ÙØª Ù†ÙˆØªÛŒÙ Ø§Ø² WS
        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            addNotification(data.message, data.ticket_url, data.notif_type || "default");
        };

        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function addNotification(message, url, notifType) {
            const notification = {
                id: generateId(),
                message, ticket_url: url,
                notif_type: notifType || "default",
                time: new Date().toISOString()
            };
            notifications.unshift(notification);
            unreadCount = notifications.length;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        function renderNotifications() {
            notifList.innerHTML = '';

            if (notifications.length === 0) {
                notifList.innerHTML = '<li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>';
            } else {
                notifications.forEach((notif) => {
                    const li = document.createElement("li");
                    li.classList.add("unread");

                    let iconEmoji = "ğŸ””";
                    if (notif.notif_type === "employee_ticket") iconEmoji = "ğŸ‘¨â€ğŸ’¼";
                    else if (notif.notif_type === "reservation") iconEmoji = "ğŸ“…";
                    else if (notif.notif_type === "suggestion") iconEmoji = "ğŸ’¡";

                    const notifTime = new Date(notif.time);
                    const mins = Math.floor((new Date() - notifTime) / (1000 * 60));
                    const timeStr = mins < 1 ? "Ù‡Ù…ÛŒÙ† Ø­Ø§Ù„Ø§" : mins + " Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´";

                    li.innerHTML = `
                        <span class="notif-icon">${iconEmoji}</span>
                        <a href="${notif.ticket_url}" data-id="${notif.id}">
                            ${notif.message}
                        </a>
                        <span class="notif-time">${timeStr}</span>
                    `;

                    li.querySelector("a").addEventListener("click", function (e) {
                        e.preventDefault();
                        const idToRemove = this.getAttribute("data-id");
                        notifications = notifications.filter(n => n.id !== idToRemove);
                        localStorage.setItem('notifications', JSON.stringify(notifications));

                        li.style.animation = "fadeOut 0.3s ease";
                        setTimeout(() => {
                            li.remove();
                            unreadCount = notifications.length;
                            notifCount.innerText = unreadCount;
                            notifCount.style.display = unreadCount > 0 ? "inline-block" : "none";
                            if (notifications.length === 0) {
                                notifList.innerHTML = '<li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>';
                            }
                            window.location.href = this.href;
                        }, 300);
                    });

                    notifList.appendChild(li);
                });
            }

            notifCount.innerText = unreadCount;
            notifCount.style.display = unreadCount > 0 ? "inline-block" : "none";
        }

        markAllRead.addEventListener("click", function () {
            notifications = [];
            unreadCount = 0;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        });

        renderNotifications();
    });
    </script>

{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {% for js_file in custom_js %}
        <script src="{% static js_file %}"></script>
    {% endfor %}
{% endblock %}
