{% extends "admin/base_site.html" %}
{% load static %}

{% block nav-global %}
    {{ block.super }}
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        #notif-icon {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
            font-size: 24px;
            color: #ffffff;
            transition: transform 0.2s ease, color 0.2s ease;
        }
        #notif-icon:hover {
            transform: scale(1.1);
            color: #ffd700;
        }

        #notif-count {
            background: linear-gradient(45deg, #ff3b30, #ff6b6b);
            color: white;
            border-radius: 50%;
            padding: 3px 8px;
            font-size: 12px;
            position: absolute;
            top: -8px;
            right: -8px;
            display: none;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        #notif-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 32px;
            background: #1c2526;
            border-radius: 12px;
            width: 360px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            font-family: 'Poppins', sans-serif;
            color: #ffffff;
        }

        #notif-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #notif-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }

        #mark-all-read {
            background: none;
            border: none;
            color: #ffd700;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        #mark-all-read:hover {
            color: #ffffff;
        }

        #notif-list {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        #notif-list li {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #notif-list li:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        #notif-list li.unread {
            background: rgba(255,215,0,0.1);
            font-weight: 500;
        }

        #notif-list li a {
            color: #ffffff;
            text-decoration: none;
            display: block;
            flex: 1;
        }

        .notif-icon {
            font-size: 16px;
            color: #ffd700;
        }

        .notif-time {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }

        #notif-list::-webkit-scrollbar {
            width: 8px;
        }
        #notif-list::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 4px;
        }
        #notif-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; height: 0; padding: 0; margin: 0; }
        }
    </style>

    <div id="notif-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span id="notif-count"></span>
        <div id="notif-dropdown">
            <div id="notif-header">
                <h3>Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</h3>
                <button id="mark-all-read">Ø®ÙˆØ§Ù†Ø¯Ù† Ù‡Ù…Ù‡</button>
            </div>
            <ul id="notif-list">
                <li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const socket = new WebSocket(protocol + "://" + window.location.host + "/ws/notifications/");

        const icon = document.getElementById("notif-icon");
        const dropdown = document.getElementById("notif-dropdown");
        const notifList = document.getElementById("notif-list");
        const notifCount = document.getElementById("notif-count");
        const markAllRead = document.getElementById("mark-all-read");

        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let unreadCount = notifications.length;

        // Toggle dropdown (Ø¨Ø¯ÙˆÙ† Ø±ÛŒØ³Øª unreadCount)
        icon.addEventListener("click", function (e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
            renderNotifications();  // Ù‡Ø± Ø¨Ø§Ø± Ø¨Ø§Ø² Ø´Ø¯Ù†ØŒ Ù„ÛŒØ³Øª Ø±Ùˆ Ø¨Ø±ÙˆØ² Ú©Ù†
        });

        // Handle WebSocket messages
        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            addNotification(data.message, data.ticket_url, data.notif_type || "default");
        };

        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function addNotification(message, url, notifType) {
            const notification = {
                id: generateId(),
                message: message,
                ticket_url: url,
                notif_type: notifType || "default",
                time: new Date().toISOString()
            };
            notifications.unshift(notification);
            unreadCount = notifications.length;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        }

        function renderNotifications() {
            notifList.innerHTML = '';

            if (notifications.length === 0) {
                notifList.innerHTML = '<li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>';
            } else {
                notifications.forEach((notif) => {
                    const li = document.createElement("li");
                    li.classList.add("unread");
                    li.style.padding = "12px 16px";
                    li.style.borderBottom = "1px solid rgba(255,255,255,0.1)";

                    let iconEmoji = "ğŸ””";
                    if (notif.notif_type === "employee_ticket") iconEmoji = "ğŸ‘¨â€ğŸ’¼";
                    else if (notif.notif_type === "reservation") iconEmoji = "ğŸ“…";
                    else if (notif.notif_type === "suggestion") iconEmoji = "ğŸ’¡";

                    const notifTime = new Date(notif.time);
                    const timeDiff = Math.floor((new Date() - notifTime) / (1000 * 60));
                    const timeStr = timeDiff < 1 ? "Ù‡Ù…ÛŒÙ† Ø­Ø§Ù„Ø§" : timeDiff + " Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´";

                    li.innerHTML = `
                        <span class="notif-icon">${iconEmoji}</span>
                        <a href="${notif.ticket_url}" style="text-decoration:none; color:#ffffff; display:block;"
                           data-id="${notif.id}">
                            ${notif.message}
                        </a>
                        <span class="notif-time">${timeStr}</span>
                    `;

                    li.querySelector("a").addEventListener("click", function (e) {
                        e.preventDefault();
                        const idToRemove = this.getAttribute("data-id");

                        notifications = notifications.filter(n => n.id !== idToRemove);
                        localStorage.setItem('notifications', JSON.stringify(notifications));

                        li.style.animation = "fadeOut 0.3s ease";
                        setTimeout(() => {
                            li.remove();
                            unreadCount = notifications.length;
                            notifCount.innerText = unreadCount;
                            notifCount.style.display = unreadCount > 0 ? "inline-block" : "none";

                            if (notifications.length === 0) {
                                notifList.innerHTML = '<li style="text-align:center; color:#888;">ğŸ”• Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>';
                            }

                            window.location.href = this.href;
                        }, 300);
                    });

                    notifList.appendChild(li);
                });
            }

            notifCount.innerText = unreadCount;
            notifCount.style.display = unreadCount > 0 ? "inline-block" : "none";
        }

        // Mark all as read
        markAllRead.addEventListener("click", function () {
            notifications = [];
            unreadCount = 0;
            localStorage.setItem('notifications', JSON.stringify(notifications));
            renderNotifications();
        });

        // Fade out animation
        const style = document.createElement("style");
        style.innerHTML = `
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; height: 0; padding: 0; margin: 0; }
            }
        `;
        document.head.appendChild(style);

        renderNotifications();  // Ø§ÙˆÙ„ÛŒÙ‡ Ù„ÙˆØ¯
    });
</script>

{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {% for js_file in custom_js %}
        <script src="{% static js_file %}"></script>
    {% endfor %}
{% endblock %}